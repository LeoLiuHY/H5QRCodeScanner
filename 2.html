<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebäºŒç»´ç æ‰«æå™¨ï¼ˆä¼˜åŒ–å±å¹•ç ï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        /* ã€æ ·å¼éƒ¨åˆ†ä¸ä¹‹å‰å®Œå…¨ä¸€è‡´ï¼Œä¸ºèŠ‚çœç¯‡å¹…å·²çœç•¥ã€‘
           è¯·ç›´æ¥ä½¿ç”¨ä¹‹å‰ä»£ç çš„å®Œæ•´<style>éƒ¨åˆ†ï¼Œæ­¤å¤„ä»…å±•ç¤ºå…³é”®æ”¹åŠ¨ */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>WebäºŒç»´ç æ‰«æå™¨ - å±å¹•ç ä¼˜åŒ–ç‰ˆ</h1>
            <p class="subtitle">å·²ä¼˜åŒ–å¯¹æ‰‹æœº/ç”µè„‘å±å¹•ä¸ŠäºŒç»´ç çš„è¯†åˆ«èƒ½åŠ›</p>
        </header>
        
        <div class="main-content">
            <div class="scanner-section">
                <div class="camera-container">
                    <div id="videoPlaceholder" class="video-placeholder">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“±</div>
                        <h3>å‡†å¤‡æ‰«æå±å¹•äºŒç»´ç </h3>
                        <p>è¯·å°†æ‘„åƒå¤´å¯¹å‡†ç”µè„‘æˆ–æ‰‹æœºå±å¹•ä¸Šçš„äºŒç»´ç </p>
                        <p style="font-size: 0.9em; margin-top: 15px; color: #e0e0ff;">ğŸ’¡ æç¤ºï¼šä¿æŒç¨³å®šï¼Œé¿å…åå…‰</p>
                    </div>
                    <video id="video" autoplay playsinline></video>
                    <div class="scan-overlay">
                        <div class="scan-frame">
                            <div class="scan-line"></div>
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button id="singleScanBtn" class="btn btn-primary" disabled>
                        <span>ğŸ“¸</span>å•æ¬¡æ‰«ç 
                    </button>
                    <button id="continuousScanBtn" class="btn btn-secondary" disabled>
                        <span>ğŸ”</span>å¼€å§‹è¿ç»­æ‰«ç 
                    </button>
                    <button id="snapshotBtn" class="btn btn-warning" disabled>
                        <span>ğŸ“·</span>æ‰‹åŠ¨æŠ“å›¾è¯†åˆ«
                    </button>
                    <button id="clearBtn" class="btn btn-danger">
                        <span>ğŸ—‘ï¸</span>æ¸…ç©ºç»“æœ
                    </button>
                </div>

                <!-- æ–°å¢ï¼šå±å¹•ç æ‰«ææŠ€å·§æç¤º -->
                <div class="tips-box">
                    <h4><span>ğŸ’¡</span> æ‰«æå±å¹•äºŒç»´ç æŠ€å·§</h4>
                    <ul>
                        <li><strong>è°ƒæ•´è·ç¦»</strong>ï¼šæ‘„åƒå¤´ç¦»å±å¹•çº¦15-30å˜ç±³ï¼Œè®©äºŒç»´ç å……æ»¡æ‰«ææ¡†</li>
                        <li><strong>é¿å…åå…‰</strong>ï¼šè°ƒæ•´è§’åº¦ï¼Œé¿å¼€ç¯å…‰åœ¨å±å¹•ä¸Šçš„åå…‰ç‚¹</li>
                        <li><strong>ä¿æŒç¨³å®š</strong>ï¼šæ‰‹æŒè®¾å¤‡æ—¶å°½é‡ä¿æŒç¨³å®šï¼Œæˆ–ä½¿ç”¨æ”¯æ¶</li>
                        <li><strong>è°ƒé«˜äº®åº¦</strong>ï¼šå°†æ˜¾ç¤ºäºŒç»´ç çš„å±å¹•äº®åº¦è°ƒåˆ°æœ€é«˜</li>
                        <li><strong>å°è¯•ã€Œæ‰‹åŠ¨æŠ“å›¾è¯†åˆ«ã€</strong>ï¼šå¦‚æœè‡ªåŠ¨æ‰«æå¤±è´¥ï¼Œä½¿ç”¨æ­¤åŠŸèƒ½</li>
                    </ul>
                </div>
                
                <!-- ã€å…¶ä»–éƒ¨åˆ†ï¼šæ‘„åƒå¤´é€‰æ‹©ã€çŠ¶æ€æ˜¾ç¤ºç­‰ä¸ä¹‹å‰ä¸€è‡´ï¼Œæ­¤å¤„çœç•¥ã€‘ -->
            </div>
            
            <div class="results-section">
                <!-- ã€ç»“æœå±•ç¤ºåŒºä¸ä¹‹å‰ä¸€è‡´ï¼Œæ­¤å¤„çœç•¥ã€‘ -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let videoStream = null;
        let videoElement = null;
        let canvasElement = null;
        let canvasContext = null;
        let isScanning = false;
        let isContinuousMode = false;
        let scanInterval = null;
        let scanResults = [];
        let lastScanTime = 0;
        const SCAN_COOLDOWN = 700; // æ‰«æå±å¹•ç éœ€è¦æ›´é•¿çš„é—´éš”

        // DOMå…ƒç´ 
        const singleScanBtn = document.getElementById('singleScanBtn');
        const continuousScanBtn = document.getElementById('continuousScanBtn');
        const snapshotBtn = document.getElementById('snapshotBtn'); // æ–°å¢ï¼šæ‰‹åŠ¨æŠ“å›¾æŒ‰é’®
        const clearBtn = document.getElementById('clearBtn');
        const video = document.getElementById('video');
        const status = document.getElementById('status');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            videoElement = video;
            
            // åˆ›å»ºCanvas
            canvasElement = document.createElement('canvas');
            canvasContext = canvasElement.getContext('2d');
            
            // äº‹ä»¶ç›‘å¬
            singleScanBtn.addEventListener('click', startSingleScan);
            continuousScanBtn.addEventListener('click', toggleContinuousScan);
            snapshotBtn.addEventListener('click', captureAndDecodeSnapshot); // æ–°å¢
            clearBtn.addEventListener('click', clearResults);
            
            // åˆå§‹åŒ–æ‘„åƒå¤´ - å…³é”®æ”¹åŠ¨ï¼šä¼˜å…ˆé€‰æ‹©åç½®æ‘„åƒå¤´
            initCameraForScreenScanning();
        });

        // ã€å‡½æ•° enumerateCameras() å’Œ startCamera() ä¸ä¹‹å‰åŸºæœ¬ä¸€è‡´ã€‘
        // ä½† startCamera çš„ constraints éœ€è¦è°ƒæ•´ï¼Œè§ä¸‹æ–¹ï¼š

        async function startCamera(deviceId) {
            // ... (åœæ­¢ç°æœ‰æ‘„åƒå¤´ç­‰å‡†å¤‡å·¥ä½œ)
            
            try {
                // ğŸ“± å…³é”®ä¼˜åŒ–ï¼šé’ˆå¯¹å±å¹•æ‰«æçš„æ‘„åƒå¤´å‚æ•°
                const constraints = {
                    video: {
                        deviceId: deviceId ? { exact: deviceId } : undefined,
                        // 1. ä¼˜å…ˆé€‰æ‹©åç½®æ‘„åƒå¤´ï¼ˆæ‰«æå±å¹•æ—¶é€šå¸¸æ•ˆæœæ›´å¥½ï¼‰
                        facingMode: { ideal: 'environment' },
                        // 2. ä¸è¦æ±‚è¿‡é«˜åˆ†è¾¨ç‡ï¼Œé¿å…å¤„ç†å‹åŠ›
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        // 3. æ˜ç¡®éœ€è¦è‡ªåŠ¨å¯¹ç„¦ï¼ˆå¾ˆå¤šæ‰‹æœºå‰ç½®æ‘„åƒå¤´æ˜¯å®šç„¦çš„ï¼‰
                        advanced: [{ focusMode: 'continuous' }]
                    }
                };
                
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = videoStream;
                
                // ç­‰å¾…è§†é¢‘å°±ç»ª
                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = () => resolve();
                });
                
                // å¯ç”¨æ‰€æœ‰æŒ‰é’®
                singleScanBtn.disabled = false;
                continuousScanBtn.disabled = false;
                snapshotBtn.disabled = false; // å¯ç”¨æ‰‹åŠ¨æŠ“å›¾æŒ‰é’®
                
                showStatus('æ‘„åƒå¤´å·²å°±ç»ªã€‚è¯·å°†å±å¹•äºŒç»´ç å¯¹å‡†æ‰«ææ¡†ã€‚', 'success');
                return true;
                
            } catch (error) {
                // ... (é”™è¯¯å¤„ç†)
                return false;
            }
        }

        // ã€å•æ¬¡æ‰«æã€è¿ç»­æ‰«æçš„å¼€å…³å‡½æ•°ä¸ä¹‹å‰ç±»ä¼¼ï¼Œä½† performScan å‡½æ•°æ˜¯å…³é”®ã€‘

        // ğŸ¯ æ ¸å¿ƒä¼˜åŒ–ï¼šæ‰§è¡ŒäºŒç»´ç æ‰«æï¼ˆä¸“é—¨ä¼˜åŒ–å±å¹•ç è¯†åˆ«ï¼‰
        async function performScan() {
            if (!videoElement.videoWidth) {
                throw new Error('è§†é¢‘æœªå°±ç»ª');
            }
            
            // 1. è®¾ç½®Canvaså°ºå¯¸ï¼ˆé€‚å½“ç¼©å°å¯æé«˜æ€§èƒ½ï¼‰
            const scaleFactor = 0.8; // ç¼©å°åˆ°80%ä»¥åŠ å¿«å¤„ç†
            canvasElement.width = videoElement.videoWidth * scaleFactor;
            canvasElement.height = videoElement.videoHeight * scaleFactor;
            
            // 2. ç»˜åˆ¶è§†é¢‘å¸§åˆ°Canvas
            canvasContext.drawImage(
                videoElement, 
                0, 0, videoElement.videoWidth, videoElement.videoHeight,
                0, 0, canvasElement.width, canvasElement.height
            );
            
            // 3. è·å–å›¾åƒæ•°æ®
            const imageData = canvasContext.getImageData(0, 0, canvasElement.width, canvasElement.height);
            
            // 4. ğŸš€ å…³é”®ä¼˜åŒ–ï¼šé…ç½®jsQRè¯†åˆ«å‚æ•°ä»¥æ›´å¥½åœ°è¯†åˆ«å±å¹•ç 
            const code = jsQR(
                imageData.data, 
                imageData.width, 
                imageData.height, 
                {
                    // å¯¹å±å¹•ç æœ€é‡è¦çš„è®¾ç½®ï¼š
                    inversionAttempts: "attemptBoth", // âœ… å¿…é¡»ï¼šå°è¯•è¯†åˆ«åè‰²ç ï¼ˆæ·±è‰²èƒŒæ™¯æµ…è‰²ç ï¼‰
                    
                    // å¯é€‰ï¼šè°ƒæ•´è¯†åˆ«é˜ˆå€¼ï¼ˆå¦‚æœé»˜è®¤å€¼æ•ˆæœä¸å¥½ï¼‰
                    // ä»¥ä¸‹å‚æ•°åœ¨jsQRæ–‡æ¡£ä¸­å¯èƒ½éœ€è¦æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬æ”¯æŒæƒ…å†µ
                    // å¦‚æœæ‰«æå›°éš¾ï¼Œå¯ä»¥å°è¯•å–æ¶ˆæ³¨é‡Šå¹¶è°ƒæ•´ï¼š
                    /*
                    greyScaleWeights: {
                        red: 0.299,
                        green: 0.587,
                        blue: 0.114
                    },
                    */
                    
                    // å¯ä»¥å°è¯•é™ä½è¦æ±‚çš„é€Ÿåº¦ä»¥æ¢å–å‡†ç¡®æ€§
                    // canOverwriteImage: false // ä¿æŒåŸå§‹å›¾åƒæ•°æ®
                }
            );
            
            if (code) {
                console.log("âœ… æˆåŠŸè¯†åˆ«äºŒç»´ç :", code.data.substring(0, 50) + "...");
                return {
                    data: code.data,
                    format: 'QR Code',
                    timestamp: new Date(),
                    source: isContinuousMode ? 'è¿ç»­' : 'å•æ¬¡'
                };
            }
            
            return null;
        }

        // ğŸ“¸ æ–°å¢ï¼šæ‰‹åŠ¨æŠ“å›¾è¯†åˆ«åŠŸèƒ½ï¼ˆé’ˆå¯¹ç‰¹åˆ«å›°éš¾çš„å±å¹•ç ï¼‰
        async function captureAndDecodeSnapshot() {
            if (!videoStream) {
                showStatus('è¯·å…ˆå¯åŠ¨æ‘„åƒå¤´', 'error');
                return;
            }
            
            showStatus('æ­£åœ¨æ•è·å›¾åƒå¹¶è¯†åˆ«...', 'info');
            
            // 1. å®Œæ•´å°ºå¯¸æ•è·
            const snapshotCanvas = document.createElement('canvas');
            const snapshotCtx = snapshotCanvas.getContext('2d');
            
            snapshotCanvas.width = videoElement.videoWidth;
            snapshotCanvas.height = videoElement.videoHeight;
            snapshotCtx.drawImage(videoElement, 0, 0);
            
            // 2. å°è¯•å¤šç§å›¾åƒå¤„ç†æ–¹å¼
            const results = [];
            
            // æ–¹å¼Aï¼šç›´æ¥è¯†åˆ«
            let imageData = snapshotCtx.getImageData(0, 0, snapshotCanvas.width, snapshotCanvas.height);
            let code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "attemptBoth"
            });
            if (code) results.push({ method: 'ç›´æ¥è¯†åˆ«', data: code.data });
            
            // æ–¹å¼Bï¼šè½¬æ¢ä¸ºç°åº¦å¹¶æé«˜å¯¹æ¯”åº¦åè¯†åˆ«ï¼ˆé’ˆå¯¹ä½å¯¹æ¯”åº¦å±å¹•ç ï¼‰
            if (!code) {
                const grayImageData = convertToHighContrastGray(imageData);
                code = jsQR(grayImageData.data, grayImageData.width, grayImageData.height, {
                    inversionAttempts: "attemptBoth"
                });
                if (code) results.push({ method: 'å¢å¼ºå¯¹æ¯”åº¦', data: code.data });
            }
            
            // 3. æ˜¾ç¤ºç»“æœ
            if (results.length > 0) {
                const bestResult = results[0];
                addResult({
                    data: bestResult.data,
                    format: 'QR Code',
                    timestamp: new Date(),
                    source: 'æ‰‹åŠ¨æŠ“å›¾ (' + bestResult.method + ')'
                }, false);
                showStatus(`æ‰‹åŠ¨æŠ“å›¾è¯†åˆ«æˆåŠŸ (${bestResult.method})!`, 'success');
                
                // çŸ­æš‚æ˜¾ç¤ºæ•è·çš„ç”»é¢ç»™ç”¨æˆ·ç¡®è®¤
                showTemporarySnapshot(snapshotCanvas);
            } else {
                showStatus('æ‰‹åŠ¨æŠ“å›¾ä¹Ÿæœªè¯†åˆ«åˆ°äºŒç»´ç ã€‚è¯·è°ƒæ•´ä½ç½®/è§’åº¦é‡è¯•ã€‚', 'error');
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šè½¬æ¢ä¸ºé«˜å¯¹æ¯”åº¦ç°åº¦å›¾åƒ
        function convertToHighContrastGray(imageData) {
            const data = imageData.data;
            const newData = new Uint8ClampedArray(data.length);
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // è½¬æ¢ä¸ºç°åº¦
                const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                
                // æé«˜å¯¹æ¯”åº¦ï¼ˆç®€å•çº¿æ€§æ‹‰ä¼¸ï¼‰
                const contrastFactor = 1.5;
                const contrasted = ((gray - 128) * contrastFactor) + 128;
                
                // é’³åˆ¶åˆ°0-255èŒƒå›´
                const finalValue = Math.max(0, Math.min(255, contrasted));
                
                newData[i] = finalValue;     // R
                newData[i + 1] = finalValue; // G
                newData[i + 2] = finalValue; // B
                newData[i + 3] = 255;        // A
            }
            
            return new ImageData(newData, imageData.width, imageData.height);
        }

        // è¾…åŠ©å‡½æ•°ï¼šçŸ­æš‚æ˜¾ç¤ºæ•è·çš„ç”»é¢
        function showTemporarySnapshot(canvas) {
            const container = document.querySelector('.camera-container');
            const img = document.createElement('img');
            img.src = canvas.toDataURL('image/png');
            img.style.cssText = `
                position: absolute; top: 0; left: 0; 
                width: 100%; height: 100%; z-index: 20;
                object-fit: contain; background: black;
            `;
            container.appendChild(img);
            
            setTimeout(() => {
                if (img.parentNode) img.parentNode.removeChild(img);
            }, 2000); // æ˜¾ç¤º2ç§’åæ¶ˆå¤±
        }

        // ã€addResult(), showStatus() ç­‰è¾…åŠ©å‡½æ•°ä¸ä¹‹å‰ä¸€è‡´ã€‘
        
        // æ–°å¢ï¼šé’ˆå¯¹å±å¹•æ‰«æçš„æ‘„åƒå¤´åˆå§‹åŒ–
        async function initCameraForScreenScanning() {
            try {
                showStatus('æ­£åœ¨åˆå§‹åŒ–æ‘„åƒå¤´ï¼ˆä¼˜åŒ–å±å¹•ç æ‰«æï¼‰...', 'info');
                
                // ç›´æ¥è¯·æ±‚åç½®æ‘„åƒå¤´
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' }, // åç½®æ‘„åƒå¤´
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = videoStream;
                
                showStatus('æ‘„åƒå¤´å·²å¯åŠ¨ã€‚è¯·å°†æ‰‹æœº/ç”µè„‘å±å¹•ä¸Šçš„äºŒç»´ç å¯¹å‡†æ‰«ææ¡†ã€‚', 'success');
                
                // å¯ç”¨æŒ‰é’®
                singleScanBtn.disabled = false;
                continuousScanBtn.disabled = false;
                snapshotBtn.disabled = false;
                
            } catch (error) {
                showStatus('æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
    </script>

    <style>
        /* æ–°å¢ï¼šæŠ€å·§æç¤ºæ¡†æ ·å¼ */
        .tips-box {
            background: linear-gradient(135deg, #f5f7ff 0%, #eef1ff 100%);
            border-left: 4px solid #4b6cb7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .tips-box h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #182848;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tips-box ul {
            margin: 0;
            padding-left: 20px;
            color: #555;
        }
        
        .tips-box li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .btn-warning {
            background-color: #f0ad4e;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #ec971f;
            transform: translateY(-2px);
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .btn {
                min-width: 100%;
                margin-bottom: 10px;
            }
            
            .tips-box {
                font-size: 13px;
                padding: 12px;
            }
        }
    </style>
</body>
</html>
